# ポケット会計 - シーケンス図

## ユーザーフローとシステム動作

以下のMermaidシーケンス図は、「ポケット会計」アプリの主要な機能とユーザー操作の流れを示しています。

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant A as アプリ
    participant C as カメラAPI
    participant O as OCRエンジン
    participant L as ローカルストレージ

    Note over U,L: 1. アプリ起動・初期化
    U->>A: アプリ起動
    A->>L: セッションデータ確認
    L-->>A: 既存データ返却
    A->>A: データ復元・初期化
    A-->>U: メイン画面表示

    Note over U,L: 2. 税設定変更
    U->>A: 税込/税抜切り替え
    A->>A: 税率計算実行
    A->>L: 設定保存
    A-->>U: 合計金額更新表示

    Note over U,L: 3. 商品追加（OCR使用）
    U->>A: カメラボタンタップ
    A->>C: カメラ起動要求
    C-->>A: カメラプレビュー
    A-->>U: カメラ画面表示
    U->>A: 撮影ボタンタップ
    A->>C: 画像キャプチャ
    C-->>A: 画像データ
    A->>O: OCR処理開始
    Note over O: 画像解析・文字認識
    O-->>A: 認識結果（価格）
    A-->>U: 価格確認画面表示
    U->>A: 価格確定 or 修正
    A->>A: 商品データ作成
    A->>L: 商品データ保存
    A->>A: 合計金額再計算
    A-->>U: 更新された一覧・合計表示

    Note over U,L: 4. 商品追加（手動入力）
    U->>A: 手動入力ボタンタップ
    A-->>U: 入力フォーム表示
    U->>A: 価格・商品名入力
    U->>A: 追加ボタンタップ
    A->>A: 入力値検証
    A->>A: 商品データ作成
    A->>L: 商品データ保存
    A->>A: 合計金額再計算
    A-->>U: 更新された一覧・合計表示

    Note over U,L: 5. 商品削除・編集
    U->>A: 商品削除ボタンタップ
    A-->>U: 削除確認ダイアログ
    U->>A: 削除確定
    A->>L: 商品データ削除
    A->>A: 合計金額再計算
    A-->>U: 更新された一覧・合計表示

    Note over U,L: 6. 買い物完了
    U->>A: 買い物完了ボタンタップ
    A-->>U: 完了確認ダイアログ
    U->>A: 完了確定
    A->>L: セッションデータクリア
    A->>A: 初期状態にリセット
    A-->>U: 新規セッション画面表示

    Note over U,L: 7. データ自動保存（バックグラウンド）
    loop 商品追加・変更時
        A->>L: リアルタイム保存
        A->>A: 合計金額自動更新
    end
```

## フロー説明

### 1. アプリ起動・初期化
- アプリ起動時に既存のセッションデータをチェック
- 中断された買い物セッションがある場合は復元
- 初回起動時は新規セッションを開始

### 2. 税設定変更
- ユーザーが税込/税抜を切り替え可能
- 変更時には既存商品の合計金額を再計算
- 設定はローカルストレージに保存

### 3. 商品追加（OCR使用）
- カメラで値札を撮影
- OCRエンジンで価格を自動認識
- 認識結果の確認・修正が可能
- 確定後は商品リストに追加

### 4. 商品追加（手動入力）
- 手動で価格と商品名を入力
- 入力値の検証を実施
- 確定後は商品リストに追加

### 5. 商品削除・編集
- 追加済み商品の個別削除が可能
- 削除前に確認ダイアログを表示
- 数量変更機能も同様のフローで実装

### 6. 買い物完了
- セッション終了時にデータをクリア
- 新しい買い物セッションを開始可能
- 履歴機能実装時は完了データを保存

### 7. データ自動保存
- 商品の追加・変更時に自動的にデータを保存
- アプリクラッシュ時のデータ損失を防止
- リアルタイムで合計金額を更新